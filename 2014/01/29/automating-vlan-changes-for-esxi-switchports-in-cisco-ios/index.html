<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Automating VLAN changes for ESXi Switchports in Cisco IOS. - Scott O'Brien</title><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css><link rel=stylesheet type=text/css href=/assets/css/normalize.css><link rel=stylesheet type=text/css href=/assets/css/icons.css><link rel=stylesheet type=text/css href=/assets/css/screen.css><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Lato:100,100i,300,300i,400,400i,700,700i|Source+Code+Pro:300,400,500,700" rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js></script>
<script type=text/javascript src=/assets/bigfoot/dist/bigfoot.js></script>
<link rel=stylesheet type=text/css href=/assets/bigfoot/dist/bigfoot-number.css><script type=text/javascript>$.bigfoot()</script></head><body class=post-template><header class=main-header><div class=main-header-content><h1 class=blog-title><a href=/>Scott O'Brien</a></h1><h2 class=blog-description>Projects, Ramblings and Resources of my (online) life</h2></div><div class=nav><a class=nav- role=presentation href=/page/bucketlist/>The Bucket List</a>
<a class=nav- role=presentation href=/page/about/>About Me</a>
<a class=nav- role=presentation href=/recipes/>Recipes</a>
<a class=nav- role=presentation href=/flying/>Flying</a></div></header><main class=content role=main><article class=post><header class=post-header><h2 class=post-title>Automating VLAN changes for ESXi Switchports in Cisco IOS.</h2><section class=post-meta><time class=post-date>January 29, 2014</time></section></header><section class=post-content><p><a href=/img/old/2014/01/product_bulletin_cisco_catalyst_6509_enhanced_vertical_chassis-1.jpg onclick='_gaq.push(["_trackEvent","outbound-article","http://www.scottyob.com"])'><img class="size-full wp-image-370 alignleft" alt=6500 src=/img/old/2014/01/product_bulletin_cisco_catalyst_6509_enhanced_vertical_chassis-1.jpg width=242 height=302></a></p><p>At the organisation I’m currently working for, we recently experienced <a href=http://www.vspecialist.co.uk/do-my-esxi-hosts-have-the-same-vlans/ onclick='_gaq.push(["_trackEvent","outbound-article","http://www.vspecialist.co.uk"])'>what appears to be a common issue</a>, VLAN’s trunked down to ESXi nodes were inconsistent.</p><p>In our DC, we’re still running the old school Cisco Catalyst switches.  If we were running a fabric, or Nexus switches <a href=http://blog.alwaysthenetwork.com/tutorials/nexus-port-profiles/ onclick='_gaq.push(["_trackEvent","outbound-article","http://blog.alwaysthenetwork.com"])'>we could put port profiles to action</a> or if we lucky enough to have some equipment running Junos &lt;3 we could be <a href=http://packetpushers.net/junos-configuration-groups/ onclick='_gaq.push(["_trackEvent","outbound-article","http://packetpushers.net"])'>using apply-groups for this</a>.</p><p>Being stuck with 6500’s in the DC as our L2 platform (and a VSS for the L3 MPLS PE) this is a quick little hack job to automate configuration changes across switchports in Cisco IOS based on dynamically finding ports that are matching an interface description.</p><p>In our DC, we have a bunch of switches (defined at the top of this script) and all our switchports that go to ESXi switchports that should have this template applied are matched on the interface description containing ‘ESXHOST’</p><p>This relies on the <a href=https://github.com/knipknap/exscript/wiki/Python-API-Tutorial onclick='_gaq.push(["_trackEvent","outbound-article","http://github.com"])'>python EXScript module</a></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green># This script is used for updating the VLANs that are trunked down to ESX boxes.</span>
</span></span><span style=display:flex><span><span style=color:green>#  It works by logging in to each switch in the DC then looking at the interfaces that have &#39;ESXHOST&#39;</span>
</span></span><span style=display:flex><span><span style=color:green>#  in the description.  For each of those switchports, it will run the &#39;alter&#39; commands</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>from</span> Exscript.Account <span style=color:#00f>import</span> Account
</span></span><span style=display:flex><span><span style=color:#00f>from</span> Exscript.protocols <span style=color:#00f>import</span> SSH2
</span></span><span style=display:flex><span><span style=color:#00f>import</span> argparse
</span></span><span style=display:flex><span><span style=color:#00f>import</span> getopt
</span></span><span style=display:flex><span><span style=color:#00f>import</span> getpass
</span></span><span style=display:flex><span><span style=color:#00f>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>#A list of the switches to interigate.  These are the switches that have ESXi hosts in them</span>
</span></span><span style=display:flex><span>SWITCHES = [
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#39;10.0.0.2&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#39;10.0.0.3&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#39;10.0.0.4&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#39;10.0.0.5&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#39;10.0.0.7&#39;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>#Commands to execute for every switchport</span>
</span></span><span style=display:flex><span>vlan_commands = <span style=color:#a31515>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>  switchport trunk allowed vlan add 5,10,15,20-25,30,40,50
</span></span></span><span style=display:flex><span><span style=color:#a31515>  switchport trunk allowed vlan add 60,69,70,100-1000
</span></span></span><span style=display:flex><span><span style=color:#a31515>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>def</span> query_yes_no(question, default=<span style=color:#a31515>&#34;yes&#34;</span>):
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;&#34;&#34;Ask a yes/no question via raw_input() and return their answer.
</span></span></span><span style=display:flex><span><span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    &#34;question&#34; is a string that is presented to the user.
</span></span></span><span style=display:flex><span><span style=color:#a31515>    &#34;default&#34; is the presumed answer if the user just hits &amp;lt;Enter&amp;gt;.
</span></span></span><span style=display:flex><span><span style=color:#a31515>        It must be &#34;yes&#34; (the default), &#34;no&#34; or None (meaning
</span></span></span><span style=display:flex><span><span style=color:#a31515>        an answer is required of the user).
</span></span></span><span style=display:flex><span><span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    The &#34;answer&#34; return value is one of &#34;yes&#34; or &#34;no&#34;.
</span></span></span><span style=display:flex><span><span style=color:#a31515>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    valid = {<span style=color:#a31515>&#34;yes&#34;</span>:<span style=color:#00f>True</span>,   <span style=color:#a31515>&#34;y&#34;</span>:<span style=color:#00f>True</span>,  <span style=color:#a31515>&#34;ye&#34;</span>:<span style=color:#00f>True</span>,
</span></span><span style=display:flex><span>             <span style=color:#a31515>&#34;no&#34;</span>:<span style=color:#00f>False</span>,     <span style=color:#a31515>&#34;n&#34;</span>:<span style=color:#00f>False</span>}
</span></span><span style=display:flex><span>    <span style=color:#00f>if</span> default == <span style=color:#00f>None</span>:
</span></span><span style=display:flex><span>        prompt = <span style=color:#a31515>&#34; [y/n] &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00f>elif</span> default == <span style=color:#a31515>&#34;yes&#34;</span>:
</span></span><span style=display:flex><span>        prompt = <span style=color:#a31515>&#34; [Y/n] &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00f>elif</span> default == <span style=color:#a31515>&#34;no&#34;</span>:
</span></span><span style=display:flex><span>        prompt = <span style=color:#a31515>&#34; [y/N] &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00f>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#00f>raise</span> ValueError(<span style=color:#a31515>&#34;invalid default answer: &#39;</span><span style=color:#a31515>%s</span><span style=color:#a31515>&#39;&#34;</span> % default)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>while</span> <span style=color:#00f>True</span>:
</span></span><span style=display:flex><span>        sys.stdout.write(question + prompt)
</span></span><span style=display:flex><span>        choice = raw_input().lower()
</span></span><span style=display:flex><span>        <span style=color:#00f>if</span> default <span style=color:#00f>is</span> <span style=color:#00f>not</span> <span style=color:#00f>None</span> <span style=color:#00f>and</span> choice == <span style=color:#a31515>&#39;&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#00f>return</span> valid[default]
</span></span><span style=display:flex><span>        <span style=color:#00f>elif</span> choice <span style=color:#00f>in</span> valid:
</span></span><span style=display:flex><span>            <span style=color:#00f>return</span> valid[choice]
</span></span><span style=display:flex><span>        <span style=color:#00f>else</span>:
</span></span><span style=display:flex><span>            sys.stdout.write(<span style=color:#a31515>&#34;Please respond with &#39;yes&#39; or &#39;no&#39; &#34;</span>\
</span></span><span style=display:flex><span>                             <span style=color:#a31515>&#34;(or &#39;y&#39; or &#39;n&#39;).</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>def</span> returnInterfacesFromShowDescription(text):
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    Returns a LIST of interfaces from the output of &#39;show interface desc&#39; from a cisco device
</span></span></span><span style=display:flex><span><span style=color:#a31515>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00f>return</span> [ x.split()[0] <span style=color:#00f>for</span> x <span style=color:#00f>in</span> text.split(<span style=color:#a31515>&#34;</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>) ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>def</span> genUpdateConfigForInterfaces(config, interfaces):
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    Takes in a configuration block to run, a list of interfaces and generates the appropriate int range commands with the
</span></span></span><span style=display:flex><span><span style=color:#a31515>    config block after
</span></span></span><span style=display:flex><span><span style=color:#a31515>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    updateConfig = <span style=color:#a31515>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00f>while</span> len(interfaces) &amp;gt; 0:
</span></span><span style=display:flex><span>        updateConfig += <span style=color:#a31515>&#34;int range &#34;</span> + <span style=color:#a31515>&#34;,&#34;</span>.join(interfaces[:5])
</span></span><span style=display:flex><span>        interfaces = interfaces[5:]
</span></span><span style=display:flex><span>        updateConfig += <span style=color:#a31515>&#34;</span><span style=color:#a31515>\n</span><span style=color:#a31515>  </span><span style=color:#a31515>%s</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span> % config.strip()
</span></span><span style=display:flex><span>    <span style=color:#00f>return</span> updateConfig
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>def</span> updateSwitchportsWithDescription(switch, description, username, password, commands):
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    Function is used to log into a switch, find all switchports that CONTAINS the description
</span></span></span><span style=display:flex><span><span style=color:#a31515>    with each of the said switchports, it will then execute the given commands.
</span></span></span><span style=display:flex><span><span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    switch:  Device to log into
</span></span></span><span style=display:flex><span><span style=color:#a31515>    description:  Search string to try and find in the switchport description
</span></span></span><span style=display:flex><span><span style=color:#a31515>    username:  Username to log into the switch with
</span></span></span><span style=display:flex><span><span style=color:#a31515>    password:  The password to log into the switch with
</span></span></span><span style=display:flex><span><span style=color:#a31515>    commands:  A list of commands that should be executed
</span></span></span><span style=display:flex><span><span style=color:#a31515>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print <span style=color:#a31515>&#34;Working with switch: </span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span> % switch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green>#establish a SSH connection to the host</span>
</span></span><span style=display:flex><span>    conn = SSH2()
</span></span><span style=display:flex><span>    account = Account(username, password)
</span></span><span style=display:flex><span>    conn.connect(switch)
</span></span><span style=display:flex><span>    conn.login(account)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green>#Do some pre-setup</span>
</span></span><span style=display:flex><span>    conn.execute(<span style=color:#a31515>&#39;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green>#Make sure we&#39;re in super user mode</span>
</span></span><span style=display:flex><span>    conn.execute(<span style=color:#a31515>&#39;enable&#39;</span>)
</span></span><span style=display:flex><span>    conn.execute(<span style=color:#a31515>&#39;terminal length 0&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green>#find all ports that have ESXHOST (or whatever is set in description) in the description</span>
</span></span><span style=display:flex><span>    conn.execute(<span style=color:#a31515>&#39;show int desc | i </span><span style=color:#a31515>%s</span><span style=color:#a31515>&#39;</span> % description)
</span></span><span style=display:flex><span>    ports = conn.response.strip()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print <span style=color:#a31515>&#34;Ports are:&#34;</span>
</span></span><span style=display:flex><span>    print ports
</span></span><span style=display:flex><span>    portsList = returnInterfacesFromShowDescription(ports)[1:-1]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green>#go into config mode and get ready to run the update commands</span>
</span></span><span style=display:flex><span>    <span style=color:green>#Generate a list of the update commands that should be ran</span>
</span></span><span style=display:flex><span>    updateCommands = genUpdateConfigForInterfaces(commands, portsList).split(<span style=color:#a31515>&#34;</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>)
</span></span><span style=display:flex><span>    conn.execute(<span style=color:#a31515>&#39;conf t&#39;</span>)
</span></span><span style=display:flex><span>    print conn.response.strip()
</span></span><span style=display:flex><span>    print <span style=color:#a31515>&#34;! About to execute the following commands.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00f>for</span> line <span style=color:#00f>in</span> updateCommands:
</span></span><span style=display:flex><span>        print <span style=color:#a31515>&#34;! &#34;</span> + line
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>if</span> query_yes_no(<span style=color:#a31515>&#39;Execute Commands?&#39;</span>, default=<span style=color:#a31515>&#34;no&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:green>#Run the set of commands given</span>
</span></span><span style=display:flex><span>        <span style=color:#00f>for</span> command <span style=color:#00f>in</span> updateCommands:
</span></span><span style=display:flex><span>            conn.execute(command)
</span></span><span style=display:flex><span>            print conn.response
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:green>#Exit out of config mode</span>
</span></span><span style=display:flex><span>        conn.execute(<span style=color:#a31515>&#34;exit&#34;</span>)
</span></span><span style=display:flex><span>        conn.execute(<span style=color:#a31515>&#34;exit&#34;</span>)
</span></span><span style=display:flex><span>        print conn.response
</span></span><span style=display:flex><span>        print
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>if</span> __name__ == <span style=color:#a31515>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    parser = argparse.ArgumentParser(description=<span style=color:#a31515>&#34;DC ESX VLAN Utility&#34;</span>)
</span></span><span style=display:flex><span>    parser.add_argument(<span style=color:#a31515>&#39;--user&#39;</span>, help=<span style=color:#a31515>&#39;The username that should be used to log into the switches with&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    args = parser.parse_args()
</span></span><span style=display:flex><span>    <span style=color:#00f>if</span> args.user:
</span></span><span style=display:flex><span>        username = args.user
</span></span><span style=display:flex><span>    <span style=color:#00f>else</span>:
</span></span><span style=display:flex><span>        username = getpass.getuser()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    password = getpass.getpass()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green># Generate a list of commands</span>
</span></span><span style=display:flex><span>    <span style=color:#00f>for</span> switch <span style=color:#00f>in</span> SWITCHES:
</span></span><span style=display:flex><span>        updateSwitchportsWithDescription(switch, <span style=color:#a31515>&#39;ESXHOST&#39;</span>, username, password, vlan_commands)
</span></span></code></pre></td></tr></table></div></div></section><footer class=post-footer></footer></article></main><footer class=site-footer><section class=rss><a class="subscribe-button icon-feed" href=/index.xml></a></section><section class=copyright>&copy; 2023 Scott O'Brien</section><section class=poweredby><a href=https://github.com/nirocfz/arabica>Arabica</a> theme by Sean Lunsford. Published with <a href=https://gohugo.io>Hugo</a>.</section></footer></body></html>