<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Easily accessing GeoIP restricted sites in your network. - Scott O'Brien</title><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css><link rel=stylesheet type=text/css href=/assets/css/normalize.css><link rel=stylesheet type=text/css href=/assets/css/icons.css><link rel=stylesheet type=text/css href=/assets/css/screen.css><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Lato:100,100i,300,300i,400,400i,700,700i|Source+Code+Pro:300,400,500,700" rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js></script>
<script type=text/javascript src=/assets/bigfoot/dist/bigfoot.js></script>
<link rel=stylesheet type=text/css href=/assets/bigfoot/dist/bigfoot-number.css><script type=text/javascript>$.bigfoot()</script></head><body class=post-template><header class=main-header><div class=main-header-content><h1 class=blog-title><a href=/>Scott O'Brien</a></h1><h2 class=blog-description>Projects, Ramblings and Resources of my (online) life</h2></div><div class=nav><a class=nav- role=presentation href=/page/bucketlist/>The Bucket List</a>
<a class=nav- role=presentation href=/page/about/>About Me</a>
<a class=nav- role=presentation href=/recipes/>Recipes</a>
<a class=nav- role=presentation href=/flying/>Flying</a></div></header><main class=content role=main><article class=post><header class=post-header><h2 class=post-title>Easily accessing GeoIP restricted sites in your network.</h2><section class=post-meta><time class=post-date>June 03, 2012</time></section></header><section class=post-content><p>We all know the problem, some sites are restricted to certain countries based on the IP address you’re using to view them.  When trying to access over-seas, some solutions are HTTP proxies, Socks proxies and the like.  The problem I have with all of these is that they’re annoying to set up whenever you want to to view the site and I don’t want to have to do that for all my devices (iPad, computer, etc).</p><p>This solution will tunnel only the sites you want over a VPN connection to be NAT’d out the other end.</p><p><a href=/img/old/2012/06/Network-Config.jpg onclick='_gaq.push(["_trackEvent","outbound-article","http://www.scottyob.com"])'><img class="aligncenter size-full wp-image-176" title="Network Config" src=/img/old/2012/06/Network-Config.jpg alt width=410 height=529></a></p><p>First we want to set up OpenVPN on the remote host by issuing “openvpn –genkey –secret static.key” then creating a file in (/etc/openvpn/server.conf)</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>port 1194
</span></span><span style=display:flex><span>proto tcp-server
</span></span><span style=display:flex><span>dev tun
</span></span><span style=display:flex><span>ifconfig 10.0.6.1 10.0.6.2 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Crypto
</span></span><span style=display:flex><span>secret /etc/openvpn/static.key
</span></span><span style=display:flex><span>comp-lzo
</span></span><span style=display:flex><span>keepalive 10 120
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Security
</span></span><span style=display:flex><span>persist-key
</span></span><span style=display:flex><span>persist-tun
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Logging
</span></span><span style=display:flex><span>status openvpn-status.log
</span></span></code></pre></td></tr></table></div></div><p>One thing we need to do on the server is set up NAT on the outbound address (to make sure all traffic that passes our VPS destined for the internet looks like it’s from that US IP address)</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Allow unlimited outbound traffic
</span></span><span style=display:flex><span>/sbin/iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</span></span><span style=display:flex><span>/sbin/iptables -A OUTPUT -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iptables -t nat -A POSTROUTING -s 10.0.6.0/24 -o eth0 -j MASQUERADE
</span></span><span style=display:flex><span>echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward
</span></span></code></pre></td></tr></table></div></div><p>On the client side, things look very similar,</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>persist-key
</span></span><span style=display:flex><span>comp-lzo no
</span></span><span style=display:flex><span>redirect-gateway def1
</span></span><span style=display:flex><span>nobind
</span></span><span style=display:flex><span>persist-tun
</span></span><span style=display:flex><span>secret secret.key
</span></span><span style=display:flex><span>dev tun
</span></span><span style=display:flex><span>ifconfig 10.0.6.2. 10.0.6.1
</span></span></code></pre></td></tr></table></div></div><p>On the client, I just also MASQUERADE’d data though (I know, double NAT’ing, easier then adjusting routing table on the VPS)</p><p>Now for the magic to happen. I just replaced the DNS server on my home router with a little Python script (&lt;3 Twisted framework) to proxy requests, adding a tunnel for IP&rsquo;s that get returned by sites in my list (in this case I&rsquo;ve chosen two fictious sites, HooLoo.com and pandoor.com</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>from twisted.internet.protocol import Factory, Protocol
</span></span><span style=display:flex><span>from twisted.internet import reactor
</span></span><span style=display:flex><span>from twisted.names import dns
</span></span><span style=display:flex><span>from twisted.names import client, server
</span></span><span style=display:flex><span>import subprocess
</span></span><span style=display:flex><span>from sys import exit
</span></span><span style=display:flex><span>from os import fork
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tunnelDomains = [
</span></span><span style=display:flex><span>  &amp;#8216;pandoor.com&amp;#8217;,
</span></span><span style=display:flex><span>  &amp;#8216;hooloo.com&amp;#8217;
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>dnsServers = [(&amp;#8216;203.12.160.35&amp;#8217;, 53), (&amp;#8216;203.12.160.36&amp;#8217;, 53)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>try:
</span></span><span style=display:flex><span>	pid = fork()
</span></span><span style=display:flex><span>	if pid &amp;gt; 0:
</span></span><span style=display:flex><span>		exit(0)
</span></span><span style=display:flex><span>except OSError, e:
</span></span><span style=display:flex><span>	exit(1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def tunnel(address):
</span></span><span style=display:flex><span>       subprocess.call([&#34;route&#34;, &#34;add&#34;, address + &#34;/32&#34;, &#34;tun0&#34;])  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class SpelDnsReolver(client.Resolver):
</span></span><span style=display:flex><span>  def filterAnswers(self, message):
</span></span><span style=display:flex><span>    if message.trunc:
</span></span><span style=display:flex><span>      return self.queryTCP(message.queries).addCallback(self.filterAnswers)
</span></span><span style=display:flex><span>    else:
</span></span><span style=display:flex><span>      for d in tunnelDomains:
</span></span><span style=display:flex><span>        if str(message.queries[0].name).endswith(d):
</span></span><span style=display:flex><span>          for answer in message.answers:
</span></span><span style=display:flex><span>            if answer.type == 1: #A record
</span></span><span style=display:flex><span>              tunnel(answer.payload.dottedQuad())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return (message.answers, message.authority, message.additional)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>verbosity = 0
</span></span><span style=display:flex><span>resolver = SpelDnsReolver(servers=dnsServers)
</span></span><span style=display:flex><span>f = server.DNSServerFactory(clients=[resolver], verbose=verbosity)
</span></span><span style=display:flex><span>p = dns.DNSDatagramProtocol(f)
</span></span><span style=display:flex><span>f.noisy = p.noisy = verbosity
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>reactor.listenUDP(53, p)
</span></span><span style=display:flex><span>reactor.listenTCP(53, f)
</span></span><span style=display:flex><span>reactor.run()
</span></span></code></pre></td></tr></table></div></div></section><footer class=post-footer></footer></article></main><footer class=site-footer><section class=rss><a class="subscribe-button icon-feed" href=/index.xml></a></section><section class=copyright>&copy; 2022 Scott O'Brien</section><section class=poweredby><a href=https://github.com/nirocfz/arabica>Arabica</a> theme by Sean Lunsford. Published with <a href=https://gohugo.io>Hugo</a>.</section></footer></body></html>